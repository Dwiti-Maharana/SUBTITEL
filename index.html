<!DOCTYPE html>
<html lang="or">
<head>
    <meta charset="UTF-8">
    <title>Odia 3D Karaoke Pro - Multi-Image Slideshow</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Odia:wght@900&display=swap" rel="stylesheet">
    
    <style>
        /* Custom Fonts */
        @font-face { font-family: 'Samaleswari'; src: url('4- samaleswari.ttf'); font-weight: 900; }
        @font-face { font-family: 'Banita'; src: url('banita.TTF'); font-weight: 900; }
        @font-face { font-family: 'Kapila'; src: url('kapila.TTF'); font-weight: 900; }
        @font-face { font-family: 'Konark'; src: url('konark.TTF'); font-weight: 900; }

        #fontPreloader { position: absolute; visibility: hidden; height: 0; width: 0; overflow: hidden; }

        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; text-align: center; margin: 0; padding: 20px; }
        .container { max-width: 850px; margin: auto; background: #1e293b; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #334155; }
        .setup-section { text-align: left; background: #334155; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #94a3b8; font-size: 14px; }
        select, input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #475569; background: #1e293b; color: white; margin-bottom: 15px; box-sizing: border-box; }
        
        #bgFileContainer { display: none; margin-top: -10px; padding: 10px; background: #1e293b; border-radius: 8px; border: 1px dashed #3b82f6; margin-bottom: 15px; }

        #syncArea { display: none; padding: 20px; }
        .tap-btn { 
            background: linear-gradient(135deg, #f59e0b, #d97706); padding: 60px; font-size: 26px; border-radius: 15px; 
            cursor: pointer; font-weight: bold; border: none; width: 100%; color: white;
            box-shadow: 0 6px 0 #92400e; margin-bottom: 20px; transition: 0.1s;
        }
        .tap-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #92400e; }

        #renderArea { display: none; margin-top: 20px; background: #000; border-radius: 15px; padding: 15px; border: 2px solid #00ff00; }
        canvas { background: #000; width: 100%; border-radius: 10px; display: block; border: 1px solid #444; }
        
        .progress-container { width: 100%; background: #334155; height: 10px; border-radius: 5px; margin: 15px 0; overflow: hidden; }
        #progressBar { width: 0%; height: 100%; background: #00ff00; transition: 0.1s; }
        .btn-blue { background: #3b82f6; color: white; padding: 16px; border: none; border-radius: 10px; font-size: 18px; cursor: pointer; width: 100%; font-weight: bold; }
        .btn-blue:disabled { background: #475569; cursor: not-allowed; }
        
        #currentSentence { 
            font-size: 32px; min-height: 80px; margin: 20px 0; font-weight: bold; 
            background: rgba(0,0,0,0.4); padding: 20px; border-radius: 12px;
            display: flex; flex-wrap: wrap; align-items: center; justify-content: center;
            border: 2px dashed #475569; line-height: 1.6;
        }
        #currentSentence span { margin: 0 8px; text-shadow: 3px 3px 0px #000; }
    </style>
</head>
<body>

<div id="fontPreloader">
    <span style="font-family: 'Samaleswari'">.</span>
    <span style="font-family: 'Banita'">.</span>
    <span style="font-family: 'Kapila'">.</span>
    <span style="font-family: 'Konark'">.</span>
</div>

<div class="container">
    <h1 style="color:#00ff00; margin-top: 0;">Odia 3D Karaoke Pro</h1>
    
    <div id="setup">
        <div class="setup-section">
            <label>1. Select Odia Font:</label>
            <select id="fontSelect">
                <option value="random">★ RANDOM FONT (One font per word)</option>
                <option value="'Noto Sans Odia'">Default (Noto Sans)</option>
                <option value="Samaleswari">Samaleswari</option>
                <option value="Banita">Banita</option>
                <option value="Kapila">Kapila</option>
                <option value="Konark">Konark</option>
            </select>

            <label>2. Select Active Word Style (Color):</label>
            <select id="styleSelect">
                <option value="mix">★ RANDOM MIX (Color per Word)</option>
                <option value="#FFFFFF">3D Pure White</option>
                <option value="#FFD700">3D Royal Gold</option>
                <option value="#00FFFF">3D Electric Cyan</option>
                <option value="#FF00FF">3D Hot Pink</option>
                <option value="#FF3131">3D Bright Red</option>
                <option value="#FF8C00">3D Deep Orange</option>
                <option value="#A020F0">3D Vivid Purple</option>
            </select>

            <label>3. Background Selection (5s Slideshow):</label>
            <select id="bgTypeSelect">
                <option value="green">Default Green Screen</option>
                <option value="image">Multiple Images (5s Each + Zoom)</option>
            </select>
            <div id="bgFileContainer">
                <label style="color:#3b82f6;">Select Background Images (Hold Ctrl to pick many):</label>
                <input type="file" id="bgImgIn" accept="image/*" multiple>
            </div>

            <label>4. Subtitle Type:</label>
            <select id="subTypeSelect">
                <option value="1">1 Word (Standard Single Highlight)</option>
                <option value="3">3 Words</option>
                <option value="4">4 Words</option>
                <option value="5">5 Words</option>
                <option value="random">★ RANDOM LAYOUT (Dynamic)</option>
            </select>

            <label>5. Audio & Text Files:</label>
            <input type="file" id="audioIn" accept="audio/*">
            <input type="file" id="textIn" accept=".txt">
        </div>
        <button id="startSync" class="btn-blue" disabled>LOADING ASSETS...</button>
    </div>

    <div id="syncArea">
        <div id="currentSentence">...</div>
        <button class="tap-btn" id="tapBtn">TAP AT END OF LINE<br><small>(or Spacebar)</small></button>
    </div>

    <div id="renderArea">
        <div style="color:#00ff00; font-weight:bold; margin-bottom:10px;">● RENDERING & RECORDING...</div>
        <canvas id="mainCanvas" width="1920" height="1080"></canvas>
        <div class="progress-container"><div id="progressBar"></div></div>
        <div id="percentText">0% Completed</div>
    </div>
</div>

<audio id="audioElement"></audio>

<script>
    const audio = document.getElementById('audioElement');
    const startSync = document.getElementById('startSync');
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const bgTypeSelect = document.getElementById('bgTypeSelect');
    const bgFileContainer = document.getElementById('bgFileContainer');
    const bgImgIn = document.getElementById('bgImgIn');
    
    const fontList = ["'Noto Sans Odia'", "Samaleswari", "Banita", "Kapila", "Konark"];
    const colors = ["#FFFFFF", "#FFD700", "#00FFFF", "#FF00FF", "#FF3131", "#FF8C00", "#A020F0"];
    
    let sentences = [];
    let timings = [];
    let currentIdx = 0;
    let lastTime = 0;
    let bgImageList = [];

    bgTypeSelect.onchange = () => {
        bgFileContainer.style.display = bgTypeSelect.value === 'image' ? 'block' : 'none';
    };

    bgImgIn.onchange = () => {
        bgImageList = [];
        const files = bgImgIn.files;
        for (let file of files) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                bgImageList.push(img);
            };
            reader.readAsDataURL(file);
        }
    };

    document.fonts.ready.then(() => {
        startSync.innerText = "START SYNCING";
        validate();
    });

    const validate = () => { 
        if(document.getElementById('audioIn').files[0] && document.getElementById('textIn').files[0]) {
            startSync.disabled = false; 
        }
    };
    document.getElementById('audioIn').onchange = validate; 
    document.getElementById('textIn').onchange = validate;

    startSync.onclick = async () => {
        const textData = await document.getElementById('textIn').files[0].text();
        sentences = textData.split(/[।\n]+/).map(s => s.trim()).filter(s => s.length > 0);
        audio.src = URL.createObjectURL(document.getElementById('audioIn').files[0]);
        document.getElementById('setup').style.display = 'none';
        document.getElementById('syncArea').style.display = 'block';
        audio.play();
        updateUI();
    };

    function updateUI() {
        const displayArea = document.getElementById('currentSentence');
        if (currentIdx < sentences.length) {
            displayArea.innerHTML = '';
            const words = sentences[currentIdx].split(' ').filter(w => w.length > 0);
            const selFont = document.getElementById('fontSelect').value;
            const selStyle = document.getElementById('styleSelect').value;

            words.forEach((word, i) => {
                const span = document.createElement('span');
                span.innerText = word;
                span.style.fontFamily = (selFont === 'random') ? fontList[i % fontList.length] : selFont;
                span.style.color = "#FFFFFF"; 
                displayArea.appendChild(span);
            });
        } else {
            document.getElementById('syncArea').style.display = 'none';
            document.getElementById('renderArea').style.display = 'block';
            startRendering();
        }
    }

    function doSync() {
        if (currentIdx < sentences.length) {
            timings.push({
                index: currentIdx,
                words: sentences[currentIdx].split(' ').filter(w => w.length > 0),
                start: lastTime,
                end: audio.currentTime
            });
            lastTime = audio.currentTime;
            currentIdx++;
            updateUI();
        }
    }

    document.getElementById('tapBtn').onclick = doSync;
    window.onkeydown = (e) => { if(e.code === 'Space') { e.preventDefault(); doSync(); } };

    function draw3D(text, x, y, color, font, isHigh, size) {
        ctx.save();
        const zoomFactor = isHigh ? 1.2 : 1.0;
        const finalSize = size * zoomFactor;
        ctx.font = `900 ${finalSize}px ${font}`;
        ctx.textAlign = 'left'; 
        ctx.textBaseline = 'middle';
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000000';
        ctx.lineWidth = finalSize * 0.22;
        ctx.strokeText(text, x, y + (finalSize * 0.05));
        ctx.lineWidth = finalSize * 0.18;
        ctx.strokeText(text, x, y);
        ctx.fillStyle = color;
        ctx.fillText(text, x, y);
        ctx.restore();
    }

    async function startRendering() {
        const selFont = document.getElementById('fontSelect').value;
        const selStyle = document.getElementById('styleSelect').value;
        const selSub = document.getElementById('subTypeSelect').value;
        const isImageMode = bgTypeSelect.value === 'image';

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioCtx.createMediaElementSource(audio);
        const dest = audioCtx.createMediaStreamDestination();
        source.connect(dest);
        source.connect(audioCtx.destination);

        const videoStream = canvas.captureStream(30);
        const combined = new MediaStream([...videoStream.getVideoTracks(), ...dest.stream.getAudioTracks()]);
        const recorder = new MediaRecorder(combined, { mimeType: 'video/webm;codecs=vp9,opus' });
        
        const chunks = [];
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'video/webm' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "karaoke_video.webm";
            a.click();
        };

        audio.currentTime = 0;
        recorder.start();
        audio.play();

        function renderLoop() {
            const now = audio.currentTime;
            const progress = (now / audio.duration) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('percentText').innerText = Math.round(progress) + '% Completed';

            // --- BACKGROUND LOGIC ---
            if (isImageMode && bgImageList.length > 0) {
                // Change image index every 5 seconds
                const imgIdx = Math.floor(now / 5) % bgImageList.length;
                const activeImg = bgImageList[imgIdx];
                
                // Animation Progress: 0 to 1 every 5 seconds
                const animProgress = (now % 5) / 5;
                const zoomValue = 1.1 + (animProgress * 0.15); // Zooms from 1.1x to 1.25x
                
                const w = canvas.width * zoomValue;
                const h = canvas.height * zoomValue;
                const x = (canvas.width - w) / 2;
                const y = (canvas.height - h) / 2;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(activeImg, x, y, w, h);
            } else {
                ctx.fillStyle = '#00FF00';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            const active = timings.find(t => now >= t.start && now <= t.end);
            
            if (active) {
                let subType = (selSub === 'random') ? (active.index % 3) + 2 : parseInt(selSub);
                let baseFontSize = (subType === 1) ? 220 : 160;
                const totalWords = active.words.length;
                const lineProgress = (now - active.start) / (active.end - active.start);
                const currentWordIdx = Math.floor(lineProgress * totalWords);
                const startIndex = (subType === 1) ? currentWordIdx : Math.floor(currentWordIdx / subType) * subType;
                const wordSlice = active.words.slice(startIndex, startIndex + subType);

                if (wordSlice.length > 0) {
                    const getWordFont = (absIdx) => (selFont === 'random') ? fontList[absIdx % fontList.length] : selFont;
                    const calculateTotalWidth = (fSize) => {
                        let total = 0;
                        wordSlice.forEach((word, i) => {
                            const absIdx = startIndex + i;
                            const isHigh = (absIdx === currentWordIdx);
                            ctx.font = `900 ${fSize * (isHigh ? 1.2 : 1.0)}px ${getWordFont(absIdx)}`;
                            total += ctx.measureText(word).width;
                        });
                        return total + (80 * (wordSlice.length - 1));
                    };

                    let totalWidth = calculateTotalWidth(baseFontSize);
                    while (totalWidth > 1750 && baseFontSize > 50) {
                        baseFontSize -= 5;
                        totalWidth = calculateTotalWidth(baseFontSize);
                    }

                    let xPos = (canvas.width - totalWidth) / 2;
                    wordSlice.forEach((word, i) => {
                        const absoluteIdx = startIndex + i;
                        const isHigh = (absoluteIdx === currentWordIdx);
                        const wordColor = isHigh ? ((selStyle === 'mix') ? colors[absoluteIdx % colors.length] : selStyle) : "#FFFFFF";
                        const wordFont = getWordFont(absoluteIdx);
                        ctx.font = `900 ${baseFontSize * (isHigh ? 1.2 : 1.0)}px ${wordFont}`;
                        const currentWordWidth = ctx.measureText(word).width;
                        draw3D(word, xPos, canvas.height/2, wordColor, wordFont, isHigh, baseFontSize);
                        xPos += currentWordWidth + 80;
                    });
                }
            }

            if (!audio.ended) requestAnimationFrame(renderLoop);
            else recorder.stop();
        }
        renderLoop();
    }
</script>

</body>
</html>